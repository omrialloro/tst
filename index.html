<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××œ×•×£ ×”×¡×œ×˜×™× ×©×œ ×”×’×œ×™×œ ×”××¢×¨×‘×™</title>
  <style>
    :root{
      --bg1:#f4fbf7;
      --bg2:#e8f7ee;
      --card:#ffffff;
      --soft:#f2fbf5;
      --ink:#0f172a;
      --muted:rgba(15,23,42,0.62);
      --border:rgba(15,23,42,0.10);
      --shadow: 0 18px 60px rgba(20,35,70,0.10);

      --green:#22c55e;
      --green2:#16a34a;

      --topH:64px;
      --leftW:360px;

      --radius:26px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 600px at 20% 15%, #ffffff 0%, var(--bg1) 35%, var(--bg2) 100%);
    }

    /* ===== Top bar ===== */
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:var(--topH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      background: rgba(255,255,255,0.70);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .topLeft, .topRight{ display:flex; align-items:center; gap:10px; }
    .iconBtn{
      width:36px; height:36px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.85);
      box-shadow: 0 10px 24px rgba(20,35,70,0.08);
      display:grid;
      place-items:center;
      color:rgba(15,23,42,0.78);
      font-weight:900;
      user-select:none;
    }
    .leaf{
      width:34px; height:34px;
      border-radius:999px;
      background: rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.35);
      display:grid;
      place-items:center;
      color: var(--green2);
      font-weight:1000;
    }
    .title{
      font-weight:1000;
      letter-spacing:0.2px;
      font-size:18px;
      color:rgba(15,23,42,0.92);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:min(64vw, 620px);
    }

    /* ===== Layout ===== */
    .page{
      padding-top: var(--topH);
      height:100%;
      display:flex;
      align-items:stretch;
    }

    /* left panel */
    .sidebar{
      width:var(--leftW);
      border-left:1px solid rgba(15,23,42,0.06);
      background: rgba(255,255,255,0.40);
      backdrop-filter: blur(8px);
      padding:18px 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .card{
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }

    /* target / hint card (top-left in ref) */
    .hintCard{
      padding:14px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .hintImg{
      width:220px;
      height:220px;
      border-radius:22px;
      background: rgba(15,23,42,0.04);
      border:1px solid rgba(15,23,42,0.10);
      object-fit:cover;
      box-shadow: 0 18px 40px rgba(20,35,70,0.10);
    }
    .hintName{
      font-size:22px;
      font-weight:1000;
      margin-top:2px;
    }
    .hintSub{
      font-size:14px;
      color:var(--muted);
      margin-top:-4px;
    }

    /* turn strip */
    .turnStrip{
      background: rgba(34,197,94,0.12);
      border:1px solid rgba(34,197,94,0.22);
      border-radius: var(--radius);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      box-shadow: 0 14px 40px rgba(34,197,94,0.08);
    }
    .turnStrip .badge{
      width:30px; height:30px;
      border-radius:999px;
      background: rgba(34,197,94,0.20);
      border:1px solid rgba(34,197,94,0.30);
      display:grid;
      place-items:center;
      color: var(--green2);
      font-weight:1000;
      flex:0 0 auto;
    }
    .turnStrip .label{
      font-size:22px;
      font-weight:1000;
    }

    /* baskets area */
    .sectionTitle{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 8px 0;
      font-size:14px;
      font-weight:1000;
      color:rgba(15,23,42,0.78);
      padding:0 6px;
    }
    .sectionTitle .bag{
      width:26px; height:26px;
      border-radius:10px;
      background: rgba(34,197,94,0.14);
      border:1px solid rgba(34,197,94,0.26);
      display:grid;
      place-items:center;
      color: var(--green2);
      font-weight:1000;
    }

    .baskets{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .playerBox{
      background: rgba(255,255,255,0.86);
      border:1px solid rgba(15,23,42,0.10);
      border-radius: 22px;
      padding:12px 12px 10px;
      box-shadow: 0 16px 50px rgba(20,35,70,0.08);
    }
    .playerBox.active{
      outline: 2px solid rgba(34,197,94,0.45);
      box-shadow: 0 20px 70px rgba(34,197,94,0.12);
    }
    .playerHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .playerName{
      font-size:16px;
      font-weight:1000;
    }
    .progressText{
      font-size:13px;
      color:rgba(15,23,42,0.58);
      font-weight:900;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(15,23,42,0.08);
      overflow:hidden;
      margin-top:8px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,0.35), rgba(34,197,94,0.95));
      border-radius:999px;
    }

    .grid{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      direction:ltr; /* keep images left-to-right inside */
      justify-content:flex-start;
    }
    .grid img{
      width:44px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(15,23,42,0.04);
      object-fit:cover;
      box-shadow: 0 10px 18px rgba(20,35,70,0.08);
      transform: translateY(0);
      transition: transform 160ms ease;
    }
    .grid img.pop{ transform: translateY(-4px) scale(1.03); }

    .countPill{
      display:none; /* kept for legacy ids; we show progress differently */
    }

    /* map area */
    .main{
      flex:1;
      padding:18px 18px 18px 0;
      display:flex;
      align-items:stretch;
      justify-content:flex-start;
    }
    .mapShell{
      flex:1;
      min-width:320px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wrap{
      position:relative;
      width:min(980px, calc(100vw - var(--leftW) - 54px));
      aspect-ratio: 1 / 1;
      border-radius: 34px;
      overflow:hidden;
      background: #f9fbfd;
      border:1px solid rgba(15,23,42,0.08);
      box-shadow: var(--shadow);
      user-select:none;
    }
    .gridBg{
      position:absolute;
      inset:0;
      background:
        linear-gradient(to right, rgba(15,23,42,0.045) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(15,23,42,0.045) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity:0.7;
      pointer-events:none;
    }
    .wrap img.map{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:0.28; /* like ref: schematic on light grid */
      filter: grayscale(0.15) contrast(1.02);
      pointer-events:none;
    }
    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    /* reveal near click */
    .reveal{
      position:absolute;
      width:150px;
      height:150px;
      border-radius:22px;
      border:1px solid rgba(15,23,42,0.12);
      background:rgba(255,255,255,0.92);
      object-fit:cover;
      box-shadow: 0 22px 70px rgba(20,35,70,0.18);
      opacity:0;
      transform: scale(0.96);
      pointer-events:none;
      transition: opacity 120ms ease, transform 120ms ease;
    }
    .reveal.on{ opacity:1; transform: scale(1); }

    /* feedback */
    .flash{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity 120ms ease;
    }
    .flash.on{ opacity:1; }
    .shake{ animation: shake 180ms ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* start + name prompts: keep from old logic, simplified */
    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(245,247,251,0.88);
      backdrop-filter: blur(10px);
      z-index:120;
    }
    /* ===== Start screen (new layout) ===== */
    #start{ overflow:hidden; }
    #start::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(520px 520px at 70% 22%, rgba(34,197,94,0.22), transparent 60%),
        radial-gradient(420px 420px at 20% 65%, rgba(34,197,94,0.14), transparent 62%),
        radial-gradient(680px 680px at 50% 110%, rgba(34,197,94,0.10), transparent 65%);
      filter: blur(0px);
      pointer-events:none;
    }
    .startTopbar{
      position:absolute;
      top:18px; left:18px; right:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      pointer-events:auto;
      z-index:3;
    }
    .tbLeft{ display:flex; gap:10px; }
    .iconBtn{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.86);
      box-shadow: 0 12px 30px rgba(20,35,70,0.12);
      display:grid;
      place-items:center;
      font-weight:900;
      color: rgba(15,23,42,0.75);
      cursor:pointer;
    }
    .iconBtn:active{ transform: translateY(1px); }
    .tbRight{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color: rgba(15,23,42,0.92);
    }
    .tbTitle{
      font-size:22px;
      letter-spacing:0.2px;
    }
    .leafBadge{
      width:44px; height:44px;
      border-radius:999px;
      background: rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.35);
      display:grid;
      place-items:center;
    }
    .leafBadge svg{ width:22px; height:22px; fill:#22c55e; }

    .startMenu{
      width:min(820px, 92vw);
      padding:38px 34px 30px;
      border-radius:44px;
      background: rgba(255,255,255,0.86);
      border:1px solid rgba(15,23,42,0.10);
      box-shadow: 0 30px 110px rgba(20,35,70,0.18);
      position:relative;
      z-index:2;
      text-align:center;
    }
    .startIcon{
      width:86px; height:86px;
      border-radius:999px;
      margin:0 auto 12px;
      background: rgba(34,197,94,0.14);
      display:grid;
      place-items:center;
    }
    .startIcon svg{ width:44px; height:44px; fill:#22c55e; }
    .startHeading{
      font-size:56px;
      font-weight:1000;
      margin:0 0 16px 0;
      letter-spacing:0.2px;
    }
    .startPills{
      width:min(560px, 86vw);
      margin:0 auto 18px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .pill{
      height:64px;
      border-radius:999px;
      background: rgba(15,23,42,0.035);
      border:1px solid rgba(15,23,42,0.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      gap:14px;
      direction:rtl;
    }
    .pillText{
      font-size:20px;
      color: rgba(15,23,42,0.72);
      font-weight:800;
    }
    .pillIcon{
      width:44px; height:44px;
      border-radius:999px;
      background:#22c55e;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      box-shadow: 0 14px 30px rgba(34,197,94,0.22);
    }
    .pillIcon svg{ width:22px; height:22px; fill:#fff; }
    .startMainBtn{
      width:min(560px, 86vw);
      height:76px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      background: linear-gradient(90deg, #22c55e, #11d86a);
      color:#0b1f12;
      font-weight:1000;
      font-size:24px;
      box-shadow: 0 26px 60px rgba(34,197,94,0.24);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin:8px auto 12px;
    }
    .startMainBtn:active{ transform: translateY(1px); filter: brightness(0.99); }
    .playTri{
      width:0; height:0;
      border-top:8px solid transparent;
      border-bottom:8px solid transparent;
      border-right:0;
      border-left:14px solid rgba(11,31,18,0.88);
      transform: translateY(1px);
    }
    .startNote{
      font-size:15px;
      color: rgba(15,23,42,0.45);
      font-weight:700;
      margin-top:8px;
    }

    .startMiniMap{
      position:absolute;
      left:34px;
      bottom:46px;
      width:260px;
      border-radius:22px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(15,23,42,0.10);
      box-shadow: 0 20px 70px rgba(20,35,70,0.16);
      z-index:1;
      opacity:0.92;
      transform: rotate(-2deg);
      pointer-events:none;
    }
    .startMiniMap img{ width:100%; height:100%; object-fit:cover; display:block; }
    .startSideArt{
      position:absolute;
      right:56px;
      bottom:58px;
      width:190px;
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(15,23,42,0.10);
      box-shadow: 0 18px 60px rgba(20,35,70,0.14);
      z-index:1;
      opacity:0.28;
      pointer-events:none;
    }
    .startSideArt img{ width:100%; height:100%; object-fit:cover; display:block; filter: saturate(1.05); }

    @media (max-width: 860px){
      .startMiniMap, .startSideArt{ display:none; }
      .startHeading{ font-size:44px; }
    }

    .startCard, .nameCard{
      width:min(92vw, 680px);
      background: rgba(255,255,255,0.92);
      border:1px solid var(--border);
      border-radius: 28px;
      box-shadow: 0 26px 90px rgba(20,35,70,0.18);
      padding:20px;
    }
    .startTitle{
      margin:0 0 10px 0;
      font-size:34px;
      font-weight:1000;
      color:#166534;
    }
    .startText{
      margin:0;
      font-size:20px;
      line-height:1.75;
      color: rgba(15,23,42,0.70);
    }
    .startList{
      margin:14px 0 0 0;
      padding:0 18px;
      font-size:20px;
      line-height:1.8;
      color: rgba(15,23,42,0.70);
    }
    .startFooter{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }
    .btn{
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding:14px 18px;
      font-weight:1000;
      font-size:20px;
      background: linear-gradient(180deg, rgba(34,197,94,0.95), rgba(22,163,74,0.95));
      color:#fff;
      box-shadow: 0 18px 44px rgba(34,197,94,0.18);
      transition: transform 120ms ease, filter 120ms ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0); filter: brightness(0.98); }

    .namePrompt{ display:none; }
    .nameTitle{ margin:0 0 8px 0; font-size:26px; font-weight:1000; }
    .nameSub{ margin:0 0 14px 0; font-size:16px; color: var(--muted); }
    .nameRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nameInput{
      flex:1; min-width:220px;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.16);
      background: rgba(15,23,42,0.03);
      padding:14px 14px;
      font-size:18px;
      outline:none;
    }
    .nameInput:focus{
      border-color: rgba(34,197,94,0.55);
      box-shadow: 0 0 0 4px rgba(34,197,94,0.12);
      background:#fff;
    }
    .nameBtn{
      border:0;
      cursor:pointer;
      border-radius:18px;
      padding:14px 18px;
      font-weight:1000;
      font-size:18px;
      background: rgba(22,101,52,0.92);
      color:#fff;
      box-shadow: 0 14px 34px rgba(22,101,52,0.16);
      white-space:nowrap;
    }

    /* win overlay */
    .win{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(10, 16, 12, 0.32);
      backdrop-filter: blur(8px);
      z-index:200;
    }
    .winCard{
      width:min(72vmin, 520px);
      aspect-ratio:1/1;
      background: rgba(255,255,255,0.96);
      border-radius: 28px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,0.12);
      box-shadow: 0 30px 100px rgba(0,0,0,0.18);
      position:relative;
    }
    .winCard img{ width:100%; height:100%; object-fit:cover; display:block; }
    .winLabel{
      position:absolute;
      left:14px; right:14px; top:14px;
      padding:12px 14px;
      border-radius:20px;
      background: rgba(255,255,255,0.82);
      border:1px solid rgba(15,23,42,0.10);
      text-align:center;
      font-weight:1000;
      font-size:22px;
    }

    @media (max-width: 980px){
      :root{ --leftW: 320px; }
      .hintImg{ width:200px; height:200px; }
      .wrap{ width: min(860px, calc(100vw - var(--leftW) - 44px)); }
    }
    @media (max-width: 860px){
      .page{ flex-direction:column; }
      .sidebar{ width:auto; border-left:0; border-top:1px solid rgba(15,23,42,0.06); }
      .main{ padding:16px; }
      .wrap{ width:min(92vw, 860px); }
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <header class="topbar">
    <div class="topLeft">
      <div class="iconBtn" title="×¢×–×¨×”">?</div>
      <div class="iconBtn" title="×”×’×“×¨×•×ª">âš™</div>
    </div>

    <div class="title">××©×—×§ ××™×¡×•×£ ×”×™×¨×§×•×ª: ×”×’×œ×™×œ ×”××¢×¨×‘×™</div>

    <div class="topRight">
      <div class="leaf" title="××œ×•×£ ×”×¡×œ×˜×™×">ğŸƒ</div>
    </div>
  </header>

  <div class="page">

    <!-- LEFT -->
    <aside class="sidebar">

      <!-- hint card -->
      <section class="card hintCard">
        <img class="hintImg" id="targetImg" alt="target" />
        <div class="hintName" id="targetLabel">×”×™×¢×“ ×©×œ×š</div>
        <div class="hintSub">×—×¤×© ×‘××™×§×•× ×”×’×œ×™×œ ×”××¢×¨×‘×™</div>
      </section>

      <!-- turn strip -->
      <section class="turnStrip" aria-live="polite">
        <div class="badge">â–¶</div>
        <div class="label" id="turnLabel">×ª×•×¨: ×©×—×§×Ÿ ×</div>
      </section>

      <!-- baskets -->
      <div class="sectionTitle">
        <div class="bag">ğŸ§º</div>
        ×¡×œ×™×
      </div>

      <section class="baskets">
        <div class="playerBox" id="boxA">
          <div class="playerHead">
            <div class="playerName" id="basketTitleA">×¢××™×ª ×œ×•×™</div>
            <div class="progressText"><span id="countA">0</span>/<span id="totalA">0</span></div>
          </div>
          <div class="bar"><i id="barA"></i></div>
          <div class="grid" id="gridA"></div>
        </div>

        <div class="playerBox" id="boxB">
          <div class="playerHead">
            <div class="playerName" id="basketTitleB">× ×•×¢×” ×›×”×Ÿ</div>
            <div class="progressText"><span id="countB">0</span>/<span id="totalB">0</span></div>
          </div>
          <div class="bar"><i id="barB"></i></div>
          <div class="grid" id="gridB"></div>
        </div>
      </section>

    </aside>

    <!-- RIGHT (MAP) -->
    <main class="main">
      <div class="mapShell">
        <div class="wrap" id="wrap">
          <div class="gridBg"></div>
          <img class="map" src="map.png" alt="map"/>
          <canvas id="c"></canvas>
          <img class="reveal" id="revealImg" alt="reveal"/>
          <div class="flash" id="flash"></div>
        </div>
      </div>
    </main>

  </div>

  <!-- Start screen -->
  <div class="overlay" id="start" style="display:flex;">
    <div class="startTopbar" dir="rtl">
      <div class="tbLeft" dir="ltr">
        <button class="iconBtn" type="button" title="×¢×–×¨×”">?</button>
        <button class="iconBtn" type="button" title="×”×’×“×¨×•×ª">âš™</button>
      </div>

      <div class="tbRight">
        <div class="tbTitle">××©×—×§ ××™×¡×•×£ ×”×™×¨×§×•×ª</div>
        <div class="leafBadge" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M20.9 3.1c-7.2.1-12 2.6-14.4 7.5C4.7 14.3 5 18.3 5 20c1.7 0 5.7.3 9.4-1.5 4.9-2.4 7.4-7.2 7.5-14.4 0-.5-.5-1-1-1ZM7.7 16.3c2.3-3.4 6-5.7 10.8-6.7-4.2 2-7.1 4.8-8.8 8.3-.9 0-1.7-.1-2.0-.1Z"/></svg>
        </div>
      </div>
    </div>

    <div class="startMiniMap"><img src="map.png" alt="×ª×¦×•×’×” ××§×“×™××” ×©×œ ×”××¤×”"></div>
    <div class="startSideArt"><img src="×¡×œ×˜.jpg" alt=""></div>

    <div class="startCard startMenu" dir="rtl">
      <div class="startIcon" aria-hidden="true">
        <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2Zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2ZM7.2 14h9.9c.8 0 1.5-.5 1.8-1.2l3-6.3c.4-.8-.2-1.7-1.1-1.7H6.2L5.5 2H2v2h2l3.6 7.6-1.4 2.6c-.5 1 .2 2.2 1.4 2.2Z"/></svg>
      </div>

      <div class="startHeading">××©×—×§ ××™×¡×•×£ ×”×™×¨×§×•×ª</div>

      <div class="startPills">
        <div class="pill">
          <span class="pillText">××©×—×§ ×œ×©× ×™ ×©×—×§× ×™×</span>
          <span class="pillIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.7 0 3-1.3 3-3S17.7 5 16 5s-3 1.3-3 3 1.3 3 3 3Zm-8 0c1.7 0 3-1.3 3-3S9.7 5 8 5 5 6.3 5 8s1.3 3 3 3Zm0 2c-2.3 0-7 1.2-7 3.5V19h14v-2.5C15 14.2 10.3 13 8 13Zm8 0c-.3 0-.6 0-.9.1 1.2.8 1.9 1.8 1.9 3.4V19h7v-2.5c0-2.3-4.7-3.5-7-3.5Z"/></svg>
          </span>
        </div>

        <div class="pill">
          <span class="pillText">×›×œ ×ª×•×¨ ××—×¤×©×™× ×™×¨×§ ×¢×œ ×”××¤×”</span>
          <span class="pillIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 2 3 5v6c0 5.6 3.8 10.7 9 12 5.2-1.3 9-6.4 9-12V5l-9-3Zm0 18c-3.5-1.1-6-4.9-6-9V6.3l6-2 6 2V11c0 4.1-2.5 7.9-6 9Z"/></svg>
          </span>
        </div>

        <div class="pill">
          <span class="pillText">×¤×’×™×¢×” × ×›×•× ×” = ×¢×•×“ ×ª×•×¨</span>
          <span class="pillIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm1 15h-2v-2h2Zm0-4h-2V7h2Z"/></svg>
          </span>
        </div>

        <div class="pill">
          <span class="pillText">××™ ×©×××œ× ×¡×œ â€” ×× ×¦×—</span>
          <span class="pillIcon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M18 2h-2c0 2.2-1.8 4-4 4S8 4.2 8 2H6c0 3 1.6 5.6 4 7v3H7v7h10v-7h-3V9c2.4-1.4 4-4 4-7Z"/></svg>
          </span>
        </div>
      </div>

      <button class="startMainBtn" id="startBtn">
        × ×ª×—×™×œ
        <span class="playTri" aria-hidden="true"></span>
      </button>

      <div class="startNote">××©×—×§ ×œ×™××•×“×™-×—×•×•×™×ª×™ ×œ×™×œ×“×™×</div>
    </div>
  </div>

  <!-- Name prompt overlay -->
  <div class="overlay namePrompt" id="namePrompt">
    <div class="nameCard">
      <h2 class="nameTitle" id="nameTitle">×©× ×”×©×—×§×Ÿ ×”×¨××©×•×Ÿ</h2>
      <p class="nameSub" id="nameSub">××™×š × ×§×¨× ×œ×š ×‘××©×—×§?</p>
      <div class="nameRow">
        <input class="nameInput" id="nameInput" type="text" maxlength="22" placeholder="×œ×“×•×’××”: ×¢×•××¨×™" autocomplete="off" />
        <button class="nameBtn" id="nameOkBtn">××™×©×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Win overlay -->
  <div class="win" id="win">
    <div class="winCard">
      <div class="winLabel" id="winLabel">â€”</div>
      <img src="×¡×œ×˜.jpg" alt="salad"/>
    </div>
  </div>

<script>
(() => {
  const start = document.getElementById('start');
  const startBtn = document.getElementById('startBtn');

  const namePrompt = document.getElementById('namePrompt');
  const nameTitle = document.getElementById('nameTitle');
  const nameSub = document.getElementById('nameSub');
  const nameInput = document.getElementById('nameInput');
  const nameOkBtn = document.getElementById('nameOkBtn');

  const wrap = document.getElementById('wrap');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const targetImg = document.getElementById('targetImg');
  const targetLabel = document.getElementById('targetLabel');

  const turnLabel = document.getElementById('turnLabel');

  const basketTitleA = document.getElementById('basketTitleA');
  const basketTitleB = document.getElementById('basketTitleB');

  const gridA = document.getElementById('gridA');
  const gridB = document.getElementById('gridB');
  const countA = document.getElementById('countA');
  const countB = document.getElementById('countB');
  const totalA = document.getElementById('totalA');
  const totalB = document.getElementById('totalB');
  const barA = document.getElementById('barA');
  const barB = document.getElementById('barB');

  const boxA = document.getElementById('boxA');
  const boxB = document.getElementById('boxB');

  const revealImg = document.getElementById('revealImg');
  const flash = document.getElementById('flash');

  const win = document.getElementById('win');
  const winLabel = document.getElementById('winLabel');

  const EXT = "jpg";
  const cropToFile = (name) => encodeURI(`${name}.${EXT}`);

  let DATA = null;
  let points = [];
  let hoverId = null;

  let allCrops = [];
  let targetCrop = null;

  const P_A = 0, P_B = 1;
  let currentPlayer = P_A;
  const collectedBy = [new Set(), new Set()];
  let gameOver = false;

  let revealTimer = null;
  let rafId = null;
  let started = false;

  // green-ish pulse
  const PULSE_RGB = { r: 34, g: 197, b: 94 };

  // player names
  let playerNames = ["×©×—×§×Ÿ ×", "×©×—×§×Ÿ ×‘"];
  let nameStep = 0; // 0 => ask player 1, 1 => ask player 2

  function safeName(s){
    const t = String(s ?? "").trim().replace(/\\s+/g, " ");
    return t || null;
  }

  function openNamePrompt(step){
    nameStep = step;
    namePrompt.style.display = 'flex';
    nameInput.value = "";

    if (step === 0){
      nameTitle.textContent = "×©× ×”×©×—×§×Ÿ ×”×¨××©×•×Ÿ";
      nameSub.textContent = "××™×š × ×§×¨× ×œ×©×—×§×Ÿ 1?";
      nameInput.placeholder = "×œ×“×•×’××”: ×¢×•××¨×™";
    } else {
      nameTitle.textContent = "×©× ×”×©×—×§×Ÿ ×”×©× ×™";
      nameSub.textContent = "×•××™×š × ×§×¨× ×œ×©×—×§×Ÿ 2?";
      nameInput.placeholder = "×œ×“×•×’××”: × ×•×¢×”";
    }
    setTimeout(() => nameInput.focus(), 0);
  }

  function closeNamePrompt(){
    namePrompt.style.display = 'none';
  }

  function applyNamesToUI(){
    basketTitleA.textContent = playerNames[P_A];
    basketTitleB.textContent = playerNames[P_B];
    setTurnUI();
  }

  function updateCounts(){
    countA.textContent = String(collectedBy[P_A].size);
    countB.textContent = String(collectedBy[P_B].size);

    totalA.textContent = String(allCrops.length);
    totalB.textContent = String(allCrops.length);

    const aPct = allCrops.length ? (100 * collectedBy[P_A].size / allCrops.length) : 0;
    const bPct = allCrops.length ? (100 * collectedBy[P_B].size / allCrops.length) : 0;

    barA.style.width = aPct.toFixed(1) + "%";
    barB.style.width = bPct.toFixed(1) + "%";
  }

  function setTurnUI(){
    const who = playerNames[currentPlayer] || ((currentPlayer === P_A) ? "×©×—×§×Ÿ ×" : "×©×—×§×Ÿ ×‘");
    turnLabel.textContent = `×ª×•×¨: ${who}`;

    // active box highlight
    boxA.classList.toggle("active", currentPlayer === P_A);
    boxB.classList.toggle("active", currentPlayer === P_B);
  }

  function missingFor(player){
    const have = collectedBy[player];
    return allCrops.filter(c => !have.has(c));
  }

  function pickTargetForCurrentPlayer(){
    const miss = missingFor(currentPlayer);
    if (miss.length === 0) {
      targetCrop = null;
      targetImg.removeAttribute('src');
      targetLabel.textContent = "×”×™×¢×“ ×©×œ×š";
      return;
    }
    const idx = Math.floor(Math.random() * miss.length);
    targetCrop = miss[idx];
    targetImg.src = cropToFile(targetCrop);
    targetImg.onerror = () => targetImg.removeAttribute('src');

    // show the crop name under image (like ref)
    targetLabel.textContent = targetCrop;
  }

  function resizeCanvas() {
    const rect = wrap.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    draw(performance.now());
  }

  function imgToCss(xImg, yImg) {
    const rect = wrap.getBoundingClientRect();
    const sx = rect.width  / DATA.imageSize.width;
    const sy = rect.height / DATA.imageSize.height;
    return { x: xImg * sx, y: yImg * sy };
  }

  function hitTest(mx, my) {
    const R = 18;
    let best = null;
    let bestD = Infinity;
    for (const p of points) {
      const pos = imgToCss(p.x, p.y);
      const d = Math.hypot(mx - pos.x, my - pos.y);
      if (d < R && d < bestD) { best = p; bestD = d; }
    }
    return best;
  }

  function draw(nowMs) {
    if (!DATA) return;
    const rect = wrap.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);

    const pulse = (Math.sin(nowMs * 0.0032) + 1) / 2;

    for (const p of points) {
      const {x, y} = imgToCss(p.x, p.y);
      const isHover = hoverId === p.id;

      const hasCrop = (p.crops && p.crops.length > 0);

      const baseR = hasCrop ? 9 : 8;

      const haloBaseInner = 18;
      const haloBaseOuter = 28;

      const ampInner = hasCrop ? 7 : 5;
      const ampOuter = hasCrop ? 10 : 7;

      const breath = pulse;

      const haloR  = haloBaseInner + ampInner * breath;
      const haloR2 = haloBaseOuter + ampOuter * breath;

      const dotAlpha = hasCrop ? (0.72) : (0.26);
      const glowAlphaOuter = hasCrop ? (0.08 + 0.08 * breath) : (0.04);
      const glowAlphaInner = hasCrop ? (0.10 + 0.10 * breath) : (0.05);

      // outer halo
      ctx.beginPath();
      ctx.arc(x, y, haloR2, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${PULSE_RGB.r},${PULSE_RGB.g},${PULSE_RGB.b},${glowAlphaOuter})`;
      ctx.fill();

      // inner halo
      ctx.beginPath();
      ctx.arc(x, y, haloR, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${PULSE_RGB.r},${PULSE_RGB.g},${PULSE_RGB.b},${glowAlphaInner})`;
      ctx.fill();

      // hover ring
      if (isHover) {
        ctx.lineWidth = 3;
        ctx.strokeStyle = `rgba(${PULSE_RGB.r},${PULSE_RGB.g},${PULSE_RGB.b},0.75)`;
        ctx.beginPath();
        ctx.arc(x, y, haloR + 6, 0, Math.PI * 2);
        ctx.stroke();
      }

      // dot
      ctx.beginPath();
      ctx.arc(x, y, baseR, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${PULSE_RGB.r},${PULSE_RGB.g},${PULSE_RGB.b},${dotAlpha})`;
      ctx.fill();

      ctx.lineWidth = 1.6;
      ctx.strokeStyle = `rgba(${PULSE_RGB.r*0.45|0},${PULSE_RGB.g*0.45|0},${PULSE_RGB.b*0.45|0},0.55)`;
      ctx.stroke();
    }
  }

  function startAnim(){
    stopAnim();
    const tick = (t) => {
      if (!DATA) { rafId = requestAnimationFrame(tick); return; }
      draw(t);
      rafId = requestAnimationFrame(tick);
    };
    rafId = requestAnimationFrame(tick);
  }

  function stopAnim(){
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function addToBasket(player, cropName){
    const img = document.createElement('img');
    img.alt = cropName;
    img.src = cropToFile(cropName);
    img.onerror = () => img.remove();

    const grid = (player === P_A) ? gridA : gridB;
    grid.appendChild(img);

    requestAnimationFrame(() => img.classList.add('pop'));
    setTimeout(() => img.classList.remove('pop'), 180);

    updateCounts();
  }

  function flashFail(){
    flash.style.background = 'rgba(239,68,68,0.14)';
    flash.classList.add('on');
    setTimeout(() => flash.classList.remove('on'), 140);

    wrap.classList.remove('shake');
    void wrap.offsetWidth;
    wrap.classList.add('shake');
    setTimeout(() => wrap.classList.remove('shake'), 200);
  }

  function flashSuccess(){
    flash.style.background = 'rgba(34,197,94,0.12)';
    flash.classList.add('on');
    setTimeout(() => flash.classList.remove('on'), 140);
  }

  function showRevealNearPoint(cropName, cssX, cssY){
    if (!cropName) return;
    if (revealTimer) clearTimeout(revealTimer);

    const rect = wrap.getBoundingClientRect();
    const w = 150, h = 150;

    let left = cssX + 14;
    let top  = cssY - h - 14;

    left = Math.max(10, Math.min(left, rect.width  - w - 10));
    top  = Math.max(10, Math.min(top,  rect.height - h - 10));

    revealImg.style.left = left + "px";
    revealImg.style.top  = top  + "px";

    revealImg.src = cropToFile(cropName);
    revealImg.onerror = () => {};

    revealImg.classList.add('on');
    revealTimer = setTimeout(() => revealImg.classList.remove('on'), 1000);
  }

  function checkWin(player){
    if (collectedBy[player].size === allCrops.length) {
      gameOver = true;
      win.style.display = 'flex';
      const winner = playerNames[player] || (player === P_A ? "×©×—×§×Ÿ ×" : "×©×—×§×Ÿ ×‘");
      winLabel.textContent = `${winner} × ×™×¦×— ğŸ¥—`;
    }
  }

  async function loadGameData() {
    const res = await fetch('annotation.json', { cache: 'no-store' });
    const json = await res.json();

    DATA = json;
    points = (DATA.annotations || []).map(a => ({
      ...a,
      crops: Array.isArray(a.crops) ? a.crops : []
    }));

    const set = new Set();
    for (const p of points) for (const c of p.crops) set.add(c);
    allCrops = [...set];

    updateCounts();
    resizeCanvas();
    setTurnUI();
    pickTargetForCurrentPlayer();
    startAnim();
  }

  function beginGameAfterNames(){
    applyNamesToUI();
    loadGameData().catch(() => {
      start.style.display = 'flex';
      started = false;
      alert('×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ annotation.json. ×•×“× ×©××ª×” ××¨×™×¥ ×“×¨×š ×©×¨×ª ××§×•××™ (×œ× file://) ×•×©×›×œ ×”×§×‘×¦×™× ×‘××•×ª×” ×ª×™×§×™×™×”.');
    });
  }

  function startNameFlow(){
    openNamePrompt(0);
  }

  function confirmName(){
    const typed = safeName(nameInput.value);
    const fallback = (nameStep === 0) ? "×©×—×§×Ÿ ×" : "×©×—×§×Ÿ ×‘";
    const finalName = typed || fallback;

    if (nameStep === 0){
      playerNames[P_A] = finalName;
      openNamePrompt(1);
    } else {
      playerNames[P_B] = finalName;
      closeNamePrompt();
      beginGameAfterNames();
    }
  }

  function startGame(){
    if (started) return;
    started = true;
    start.style.display = 'none';
    startNameFlow();
  }

  // Name prompt handlers
  nameOkBtn.addEventListener('click', confirmName);
  nameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') confirmName();
  });

  // Map interactions
  wrap.addEventListener('mousemove', (e) => {
    if (!DATA || gameOver) return;
    const r = wrap.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    const hit = hitTest(mx, my);
    hoverId = hit ? hit.id : null;
  });
  wrap.addEventListener('mouseleave', () => { hoverId = null; });

  wrap.addEventListener('click', (e) => {
    if (!DATA || !targetCrop || gameOver) return;

    const r = wrap.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    const hit = hitTest(mx, my);
    if (!hit) return;

    const hidden = (hit.crops && hit.crops.length) ? hit.crops[0] : null;
    showRevealNearPoint(hidden, mx, my);

    const match = hit.crops.includes(targetCrop);

    if (match) {
      flashSuccess();

      if (!collectedBy[currentPlayer].has(targetCrop)) {
        collectedBy[currentPlayer].add(targetCrop);
        addToBasket(currentPlayer, targetCrop);
      }

      checkWin(currentPlayer);
      if (gameOver) return;

      // correct => same player continues
      pickTargetForCurrentPlayer();
      setTurnUI();
    } else {
      flashFail();
      currentPlayer = (currentPlayer === P_A) ? P_B : P_A;
      setTurnUI();
      pickTargetForCurrentPlayer();
    }
  });

  window.addEventListener('resize', resizeCanvas);
  startBtn.addEventListener('click', startGame);

  resizeCanvas();
})();
</script>
</body>
</html>
